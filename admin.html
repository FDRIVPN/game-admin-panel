<!DOCTYPE html> 
<html lang="fa" dir="rtl"> 
<head> 
  <meta charset="UTF-8" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/> 
  <title>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø§Ø²ÛŒ</title> 
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/> 
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/> 
  <style>
  :root {
    --primary: #6366f1;
    --danger: #ef4444;
    --success: #10b981;
    --dark: #1f2937;
    --light: #f9fafb;
  }
  .dark { background: #111827; color: #e5e7eb; }
  .card { transition: all 0.3s; cursor: pointer; }
  .card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
  .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  .hidden { display: none; }
  .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 999; display: flex; justify-content: center; align-items: center; }
  .modal-content { background: #fff; padding: 24px; border-radius: 16px; max-width: 90%; max-height: 90%; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
  .modal-dark { background: #1f2937; color: #e5e7eb; }

  /* Ø§Ø³Ú©Ø±ÙˆÙ„Ø¨Ø§Ø± Ø´ÛŒÚ© */
  ::-webkit-scrollbar { width: 10px; }
  ::-webkit-scrollbar-track { background: #f3f4f6; border-radius: 10px; }
  ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
  .dark ::-webkit-scrollbar-track { background: #374151; }
  .dark ::-webkit-scrollbar-thumb { background: #6b7280; }
</style>
</head> 
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen transition-colors"> 
  <div class="container mx-auto p-4 max-w-7xl"> 
    <header class="text-center mb-8"> 
      <h1 class="text-4xl font-bold gradient-bg bg-clip-text text-transparent">ğŸ® Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø§Ø²ÛŒ</h1> 
      <p class="text-gray-600 dark:text-gray-400 mt-2">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†, Ø³Ú©Ù‡, Ø¬Ù…, Ø¨Ù† Ø¯Ø³ØªÙ‡â€ŒØ¬Ù…Ø¹ÛŒ, Ú¯Ù†Ø¬â€ŒÙ‡Ø§ Ùˆ Ú†Øªâ€ŒÙ‡Ø§</p> 
      <button id="themeToggle" class="mt-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700"> 
        <i class="fas fa-moon"></i> 
      </button> 
    </header> 
    <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø± (6 Ú©Ø§Ø±Øª) --> 
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8"> 
      <div id="cardTotalUsers" class="card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col justify-between"> 
        <div> 
          <p class="text-sm text-gray-500 dark:text-gray-400">Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p> 
          <p id="totalUsers" class="text-3xl font-extrabold mt-1">...</p> 
        </div> 
        <i class="fas fa-users text-4xl text-indigo-400 self-end"></i> 
      </div> 
      <div id="cardTotalActive" class="card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col justify-between"> 
        <div> 
          <p class="text-sm text-gray-500 dark:text-gray-400">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„</p> 
          <p id="totalActive" class="text-3xl font-extrabold mt-1">...</p> 
        </div> 
        <i class="fas fa-user-check text-4xl text-green-400 self-end"></i> 
      </div> 
      <div id="cardNewToday" class="card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col justify-between"> 
        <div> 
          <p class="text-sm text-gray-500 dark:text-gray-400">Ø¬Ø¯ÛŒØ¯ Ø§Ù…Ø±ÙˆØ²</p> 
          <p id="newToday" class="text-3xl font-extrabold mt-1">...</p> 
        </div> 
        <i class="fas fa-user-plus text-4xl text-yellow-400 self-end"></i> 
      </div> 
      <div id="cardTotalCoins" class="card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col justify-between"> 
        <div> 
          <p class="text-sm text-gray-500 dark:text-gray-400">Ú©Ù„ Ø³Ú©Ù‡â€ŒÙ‡Ø§</p> 
          <p id="totalCoins" class="text-3xl font-extrabold mt-1">...</p> 
        </div> 
        <i class="fas fa-coins text-4xl text-amber-400 self-end"></i> 
      </div> 
      <div id="cardTotalGems" class="card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col justify-between"> 
        <div> 
          <p class="text-sm text-gray-500 dark:text-gray-400">Ú©Ù„ Ø¬Ù…â€ŒÙ‡Ø§</p> 
          <p id="totalGems" class="text-3xl font-extrabold mt-1">...</p> 
        </div> 
        <i class="fas fa-gem text-4xl text-emerald-400 self-end"></i> 
      </div> 
      <div id="cardBannedNow" class="card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col justify-between"> 
        <div> 
          <p class="text-sm text-gray-500 dark:text-gray-400">Ø¨Ù† Ø´Ø¯Ù‡â€ŒÙ‡Ø§</p> 
          <p id="bannedNow" class="text-3xl font-extrabold mt-1">...</p> 
        </div> 
        <i class="fas fa-ban text-4xl text-red-400 self-end"></i> 
      </div> 
    </div> 
    <!-- Ø¨Ø®Ø´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹ --> 
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"> 
      <button id="btnShowRecentChats" class="bg-gradient-to-r from-blue-500 to-blue-700 text-white p-4 rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center"> 
        <i class="fas fa-comments ml-2"></i> Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ± 
      </button> 
      <button id="btnShowBulkBan" class="bg-gradient-to-r from-red-500 to-red-700 text-white p-4 rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center"> 
        <i class="fas fa-users-slash ml-2"></i> Ø¨Ù† Ø¯Ø³ØªÙ‡â€ŒØ¬Ù…Ø¹ÛŒ (100 Ú©Ø§Ø±Ø¨Ø±) 
      </button> 
      <button id="btnShowListBanned" class="bg-gradient-to-r from-orange-500 to-orange-700 text-white p-4 rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center"> 
        <i class="fas fa-list ml-2"></i> Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù† Ø´Ø¯Ù‡ 
      </button> 
    </div> 
    <!-- ØªØ¨â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù --> 
    <div class="mb-8"> 
      <div class="flex border-b dark:border-gray-700"> 
        <button class="tab-btn active px-4 py-2 font-medium text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-500" data-tab="tab-users">Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button> 
        <button class="tab-btn px-4 py-2 font-medium text-gray-600 dark:text-gray-400" data-tab="tab-search-job">Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´ØºÙ„</button> 
        <button class="tab-btn px-4 py-2 font-medium text-gray-600 dark:text-gray-400" data-tab="tab-treasures">Ú¯Ù†Ø¬â€ŒÙ‡Ø§</button> 
        <button class="tab-btn px-4 py-2 font-medium text-gray-600 dark:text-gray-400" data-tab="tab-convert">ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ø²</button> 
        <button class="tab-btn px-4 py-2 font-medium text-gray-600 dark:text-gray-400" data-tab="tab-leaderboard">Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯</button> 
      </div> 
      <div id="tab-users" class="tab-content p-4 bg-white dark:bg-gray-800 rounded-b-xl rounded-tr-xl shadow-lg"> 
        <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØªØ¨ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† --> 
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8"> 
          <h2 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-search ml-2"></i> Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ú©Ø§Ø±Ø¨Ø±</h2> 
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Ù†Ø§Ù… ÛŒØ§ Ø¨Ø®Ø´ÛŒ Ø§Ø² Ø´Ù†Ø§Ø³Ù‡ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯.</p> 
          <div class="flex flex-col md:flex-row gap-4"> 
            <input id="userSearchInput" type="text" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ Ø¨Ø®Ø´ÛŒ Ø§Ø² Ø´Ù†Ø§Ø³Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." class="flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"/> 
            <button id="searchButton" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition w-full md:w-auto flex items-center justify-center"> 
              <i class="fas fa-search ml-2"></i> Ø¬Ø³ØªØ¬Ùˆ 
            </button> 
          </div> 
          <!-- Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ --> 
          <div id="searchResults" class="hidden mt-4"> 
            <h3 class="font-bold mb-2">Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ:</h3> 
            <div id="searchResultsList" class="space-y-2"></div> 
          </div> 
        </div> 
        <!-- Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ø±Ø¨Ø± --> 
        <div id="userDetails" class="hidden bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8"> 
          <h2 class="text-2xl font-bold mb-4 text-indigo-600 dark:text-indigo-400 flex items-center"><i class="fas fa-user-circle ml-2"></i> Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ø±Ø¨Ø±: <span id="userName" class="mr-1"></span></h2> 
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6"> 
            <div class="col-span-1 md:col-span-4 border-b pb-4 mb-4"> 
              <p class="text-sm text-gray-500 dark:text-gray-400">Ø´Ù†Ø§Ø³Ù‡: <span id="detailId" class="text-gray-900 dark:text-white font-mono text-sm"></span></p> 
              <p class="text-sm text-gray-500 dark:text-gray-400">ØªØ§Ø±ÛŒØ® Ø³Ø§Ø®Øª: <span id="detailCreatedAt" class="text-gray-900 dark:text-white text-sm"></span></p> 
              <p class="text-sm text-gray-500 dark:text-gray-400">Ø¢Ø®Ø±ÛŒÙ† ÙˆØ±ÙˆØ¯: <span id="detailLastLogin" class="text-gray-900 dark:text-white text-sm"></span></p> 
              <p class="text-sm text-gray-500 dark:text-gray-400">Ú©Ø¯ Ø¯Ø¹ÙˆØª: <span id="detailReferral" class="text-gray-900 dark:text-white font-mono text-sm"></span></p> 
              <p class="text-sm text-gray-500 dark:text-gray-400 flex items-center"> ÙˆØ¶Ø¹ÛŒØª: <span id="detailActive" class="mr-1 font-bold"></span> <span id="detailAdmin" class="text-xs mr-2 p-1 rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300"></span> </p> 
              <p class="text-sm text-gray-500 dark:text-gray-400">Ø¨Ù† ØªØ§: <span id="detailBan" class="text-red-500 font-bold"></span></p> 
              <p class="text-sm text-gray-500 dark:text-gray-400">Ù†Ù‚Ø´: <span id="detailRole" class="font-bold"></span></p> 
            </div> 
            <div class="p-4 border dark:border-gray-700 rounded-lg col-span-1 md:col-span-2"> 
              <h3 class="font-semibold mb-3">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ (Ù†Ø§Ù…, Ø³Ú©Ù‡, Ø¬Ù…, Ø´ØºÙ„)</h3> 
              <div class="mb-3"> 
                <label class="block text-sm font-medium mb-1">Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ (<span id="currentName"></span>)</label> 
                <input id="editName" type="text" placeholder="Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ (Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯)" class="w-full p-2 border dark:border-gray-600 dark:bg-gray-700 rounded-md"/> 
              </div> 
              <div class="mb-3"> 
                <label class="block text-sm font-medium mb-1">Ø³Ú©Ù‡â€ŒÙ‡Ø§ (<span id="currentCoins">0</span>)</label> 
                <input id="editCoins" type="number" placeholder="Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø³Ú©Ù‡" class="w-full p-2 border dark:border-gray-600 dark:bg-gray-700 rounded-md"/> 
              </div> 
              <div class="mb-3"> 
                <label class="block text-sm font-medium mb-1">Ø¬Ù…â€ŒÙ‡Ø§ (<span id="currentGem">0</span>)</label> 
                <input id="editGem" type="number" placeholder="Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø¬Ù…" class="w-full p-2 border dark:border-gray-600 dark:bg-gray-700 rounded-md"/> 
              </div> 
              <div class="mb-3"> 
                <label class="block text-sm font-medium mb-1">Ø´ØºÙ„ (<span id="currentJob">Ø¨ÛŒÚ©Ø§Ø±</span>)</label> 
                <input id="editJob" type="text" placeholder="Ø´ØºÙ„ Ø¬Ø¯ÛŒØ¯" class="w-full p-2 border dark:border-gray-600 dark:bg-gray-700 rounded-md"/> 
              </div> 
              <div class="mb-3"> 
                <label class="block text-sm font-medium mb-1">Ù†Ù‚Ø´</label> 
                <select id="editRole" class="w-full p-2 border dark:border-gray-600 dark:bg-gray-700 rounded-md"> 
                  <option value="user">Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ</option> 
                  <option value="admin">Ø§Ø¯Ù…ÛŒÙ†</option> 
                  <option value="inspector">Ø¨Ø§Ø²Ø±Ø³</option> 
                  <option value="special_inspector">Ø¨Ø§Ø²Ø±Ø³ ÙˆÛŒÚ˜Ù‡</option> 
                  <option value="supporter">Ù¾Ø´ØªÛŒØ¨Ø§Ù†</option> 
                </select> 
              </div> 
              <button id="updateInfoButton" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition w-full mt-2"> 
                <i class="fas fa-save ml-2"></i> Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª 
              </button> 
              <button id="viewNameHistoryButton" class="bg-gray-600 text-white p-2 rounded-lg hover:bg-gray-700 transition w-full mt-2"> 
                <i class="fas fa-history ml-2"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø§Ù…â€ŒÙ‡Ø§ 
              </button> 
            </div> 
            <div class="p-4 border dark:border-gray-700 rounded-lg"> 
              <h3 class="font-semibold mb-3">Ø³Ø·Ø­/ØªØ¬Ø±Ø¨Ù‡</h3> 
              <div class="mb-3"> 
                <label class="block text-sm font-medium mb-1">Ø³Ø·Ø­ (<span id="currentLevel">1</span>)</label> 
                <input id="editLevel" type="number" placeholder="Ø³Ø·Ø­ Ø¬Ø¯ÛŒØ¯" class="w-full p-2 border dark:border-gray-600 dark:bg-gray-700 rounded-md"/> 
              </div> 
              <div class="mb-3"> 
                <label class="block text-sm font-medium mb-1">ØªØ¬Ø±Ø¨Ù‡ (<span id="currentExp">0</span>)</label> 
                <input id="editExp" type="number" placeholder="ØªØ¬Ø±Ø¨Ù‡ Ø¬Ø¯ÛŒØ¯" class="w-full p-2 border dark:border-gray-600 dark:bg-gray-700 rounded-md"/> 
              </div> 
              <button id="updateLevelExpButton" class="bg-yellow-600 text-white p-2 rounded-lg hover:bg-yellow-700 transition w-full mt-2"> 
                <i class="fas fa-level-up-alt ml-2"></i> Ø°Ø®ÛŒØ±Ù‡ Ø³Ø·Ø­/ØªØ¬Ø±Ø¨Ù‡ 
              </button> 
            </div> 
            <div class="p-4 border border-red-300 dark:border-red-700 rounded-lg bg-red-50 dark:bg-red-900"> 
              <h3 class="font-semibold mb-3 text-red-600 dark:text-red-400">Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ/Ú†Øª</h3> 
              <button id="viewChatHistoryButton" class="bg-indigo-700 text-white p-2 rounded-lg hover:bg-indigo-800 transition w-full mb-3"> 
                <i class="fas fa-comments ml-2"></i> Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øª 
              </button> 
              <hr class="my-3 border-red-500 dark:border-red-600"> 
              <div class="mb-3"> 
                <label class="block text-sm font-medium mb-1">Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø¨Ù† (Ø¯Ù‚ÛŒÙ‚Ù‡)</label> 
                <input id="banMinutes" type="number" placeholder="Ù…Ø«Ø§Ù„: 240 (4 Ø³Ø§Ø¹Øª)" class="w-full p-2 border dark:border-gray-600 dark:bg-gray-700 rounded-md"/> 
              </div> 
              <button id="banButton" class="bg-red-600 text-white p-2 rounded-lg hover:bg-red-700 transition w-full mt-2"> 
                <i class="fas fa-hammer ml-2"></i> Ø§Ø¹Ù…Ø§Ù„ Ø¨Ù† 
              </button> 
              <button id="unbanButton" class="bg-gray-600 text-white p-2 rounded-lg hover:bg-gray-700 transition w-full mt-2"> 
                <i class="fas fa-undo-alt ml-2"></i> Ø­Ø°Ù Ø¨Ù† 
              </button> 
              <button id="toggleAdminButton" class="bg-yellow-800 text-white p-2 rounded-lg hover:bg-yellow-900 transition w-full mt-2"> 
                <i class="fas fa-user-shield ml-2"></i> ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø§Ø¯Ù…ÛŒÙ† 
              </button> 
              <button id="toggleActiveButton" class="bg-purple-800 text-white p-2 rounded-lg hover:bg-purple-900 transition w-full mt-2"> 
                <i class="fas fa-power-off ml-2"></i> ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† 
              </button> 
              <button id="deleteButton" class="bg-red-800 text-white p-2 rounded-lg hover:bg-red-900 transition w-full mt-4"> 
                <i class="fas fa-trash-alt ml-2"></i> Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø± (ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª) 
              </button> 
            </div> 
          </div> 
        </div> 
        <!-- Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø®ÛŒØ± --> 
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg"> 
          <h2 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-table ml-2"></i> Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø®ÛŒØ± (<span id="userCount">...</span>)</h2> 
          <div class="overflow-x-auto"> 
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"> 
              <thead class="bg-gray-50 dark:bg-gray-700"> 
                <tr> 
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ID / Ù†Ø§Ù…</th> 
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø³Ú©Ù‡ / Ø¬Ù…</th> 
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø³Ø·Ø­ / Ø´ØºÙ„</th> 
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ØªØ§Ø±ÛŒØ® Ø³Ø§Ø®Øª</th> 
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø¢Ø®Ø±ÛŒÙ† ÙˆØ±ÙˆØ¯</th> 
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ÙˆØ¶Ø¹ÛŒØª / Ù†Ù‚Ø´</th> 
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø¹Ù…Ù„ÛŒØ§Øª</th> 
                </tr> 
              </thead> 
              <tbody id="userListBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"> 
                <tr><td colspan="7" class="p-4 text-center text-gray-500 dark:text-gray-400">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr> 
              </tbody> 
            </table> 
          </div> 
          <div class="flex justify-between items-center mt-4"> 
            <div id="pageInfo" class="text-sm text-gray-600 dark:text-gray-400"></div> 
            <div> 
              <button id="prevPageButton" class="px-4 py-2 text-sm font-medium rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition" disabled> Ù‚Ø¨Ù„ÛŒ </button> 
              <button id="nextPageButton" class="px-4 py-2 text-sm font-medium rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition mr-2" disabled> Ø¨Ø¹Ø¯ÛŒ </button> 
            </div> 
          </div> 
        </div> 
      </div> 
      <div id="tab-search-job" class="tab-content hidden p-4 bg-white dark:bg-gray-800 rounded-b-xl rounded-tr-xl shadow-lg"> 
        <h2 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-briefcase ml-2"></i> Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´ØºÙ„</h2> 
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Ù†Ø§Ù… Ø´ØºÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: Ù…Ø¹Ù„Ù…, Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³, ...). Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø®Ø´ÛŒ Ø§Ø² Ù†Ø§Ù… Ø´ØºÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</p> 
        <div class="flex flex-col md:flex-row gap-4"> 
          <input id="jobSearchInput" type="text" placeholder="Ø´ØºÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." class="flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg"/> 
          <button id="jobSearchButton" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition w-full md:w-auto flex items-center justify-center"> 
            <i class="fas fa-search ml-2"></i> Ø¬Ø³ØªØ¬Ùˆ 
          </button> 
        </div> 
        <div id="jobSearchResults" class="hidden mt-4"> 
          <h3 class="font-bold mb-2">Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ:</h3> 
          <div id="jobSearchResultsList" class="space-y-2"></div> 
        </div> 
      </div> 
      <div id="tab-treasures" class="tab-content hidden p-4 bg-white dark:bg-gray-800 rounded-b-xl rounded-tr-xl shadow-lg"> 
        <h2 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-gem ml-2"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ú¯Ù†Ø¬â€ŒÙ‡Ø§</h2> 
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Ù…Ù‚Ø¯Ø§Ø± Ø³Ú©Ù‡ Ùˆ Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± (Ø¨Ù‡ Ø«Ø§Ù†ÛŒÙ‡) Ù‡Ø± Ú¯Ù†Ø¬ Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.</p> 
        <div class="mb-4 flex flex-col md:flex-row gap-4"> 
          <input id="newTreasureName" type="text" placeholder="Ù†Ø§Ù… Ú¯Ù†Ø¬ Ø¬Ø¯ÛŒØ¯" class="flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg"/> 
          <input id="newTreasureCoins" type="number" placeholder="Ø³Ú©Ù‡ Ø¬Ø§ÛŒØ²Ù‡" class="w-full md:w-28 p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg"/> 
          <input id="newTreasureDuration" type="number" placeholder="Ø²Ù…Ø§Ù† (Ø«Ø§Ù†ÛŒÙ‡)" class="w-full md:w-28 p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg"/> 
          <button id="addTreasureBtn" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition w-full md:w-auto flex items-center justify-center"> 
            <i class="fas fa-plus ml-2"></i> Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú¯Ù†Ø¬ 
          </button> 
        </div> 
        <div class="overflow-x-auto"> 
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"> 
            <thead class="bg-gray-50 dark:bg-gray-700"> 
              <tr> 
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ID Ú¯Ù†Ø¬</th> 
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ù†Ø§Ù…</th> 
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø³Ú©Ù‡ Ø¬Ø§ÛŒØ²Ù‡</th> 
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø²Ù…Ø§Ù† (Ø«Ø§Ù†ÛŒÙ‡)</th> 
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø¹Ù…Ù„ÛŒØ§Øª</th> 
              </tr> 
            </thead> 
            <tbody id="treasureListBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"> 
              <tr><td colspan="5" class="p-4 text-center text-gray-500 dark:text-gray-400">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯Ù†Ø¬â€ŒÙ‡Ø§...</td></tr> 
            </tbody> 
          </table> 
        </div> 
      </div> 
      <div id="tab-convert" class="tab-content hidden p-4 bg-white dark:bg-gray-800 rounded-b-xl rounded-tr-xl shadow-lg"> 
        <h2 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-exchange-alt ml-2"></i> ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ø² (Ø³Ú©Ù‡ Ùˆ Ø¬Ù…)</h2> 
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">ØªØ¨Ø¯ÛŒÙ„ Ø³Ú©Ù‡ Ø¨Ù‡ Ø¬Ù… Ùˆ Ø¬Ù… Ø¨Ù‡ Ø³Ú©Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†.</p> 
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6"> 
          <div class="p-4 border dark:border-gray-700 rounded-lg"> 
            <h3 class="font-semibold mb-3">ØªØ¨Ø¯ÛŒÙ„ Ø³Ú©Ù‡ Ø¨Ù‡ Ø¬Ù…</h3> 
            <div class="mb-3"> 
              <label class="block text-sm font-medium mb-1">Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±</label> 
              <input id="convertUserId" type="text" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±" class="w-full p-2 border dark:border-gray-600 dark:bg-gray-700 rounded-md"/> 
            </div> 
            <div class="mb-3"> 
              <label class="block text-sm font-medium mb-1">Ù…Ù‚Ø¯Ø§Ø± Ø¬Ù… Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±</label> 
              <input id="coinsToGemAmount" type="number" placeholder="ØªØ¹Ø¯Ø§Ø¯ Ø¬Ù…" class="w-full p-2 border dark:border-gray-600 dark:bg-gray-700 rounded-md"/> 
              <p class="text-xs text-gray-500 mt-1">Ù‡Ø± 1 Ø¬Ù… = 1000 Ø³Ú©Ù‡</p> 
            </div> 
            <button id="convertCoinsToGemButton" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition w-full"> 
              <i class="fas fa-exchange-alt ml-2"></i> ØªØ¨Ø¯ÛŒÙ„ Ø³Ú©Ù‡ Ø¨Ù‡ Ø¬Ù… 
            </button> 
          </div> 
          <div class="p-4 border dark:border-gray-700 rounded-lg"> 
            <h3 class="font-semibold mb-3">ØªØ¨Ø¯ÛŒÙ„ Ø¬Ù… Ø¨Ù‡ Ø³Ú©Ù‡</h3> 
            <div class="mb-3"> 
              <label class="block text-sm font-medium mb-1">Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±</label> 
              <input id="convertUserId2" type="text" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±" class="w-full p-2 border dark:border-gray-600 dark:bg-gray-700 rounded-md"/> 
            </div> 
            <div class="mb-3"> 
              <label class="block text-sm font-medium mb-1">Ù…Ù‚Ø¯Ø§Ø± Ø¬Ù…</label> 
              <input id="gemToCoinsAmount" type="number" placeholder="ØªØ¹Ø¯Ø§Ø¯ Ø¬Ù…" class="w-full p-2 border dark:border-gray-600 dark:bg-gray-700 rounded-md"/> 
              <p class="text-xs text-gray-500 mt-1">Ù‡Ø± 1 Ø¬Ù… = 800 Ø³Ú©Ù‡</p> 
            </div> 
            <button id="convertGemToCoinsButton" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition w-full"> 
              <i class="fas fa-exchange-alt ml-2"></i> ØªØ¨Ø¯ÛŒÙ„ Ø¬Ù… Ø¨Ù‡ Ø³Ú©Ù‡ 
            </button> 
          </div> 
        </div> 
      </div> 
      <div id="tab-leaderboard" class="tab-content hidden p-4 bg-white dark:bg-gray-800 rounded-b-xl rounded-tr-xl shadow-lg"> 
        <h2 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-trophy ml-2"></i> Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯ Ø¨Ø§Ø²ÛŒ</h2> 
        <div class="mb-4"> 
          <button id="showCoinsLeaderboard" class="bg-amber-500 text-white px-4 py-2 rounded-l-lg">Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯ Ø³Ú©Ù‡</button> 
          <button id="showGemsLeaderboard" class="bg-emerald-500 text-white px-4 py-2 rounded-r-lg">Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯ Ø¬Ù…</button> 
        </div> 
        <div id="leaderboardContainer"> 
          <div class="text-center text-gray-500 dark:text-gray-400 py-8"> 
            <i class="fas fa-spinner fa-spin text-3xl mb-2"></i> 
            <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯...</p> 
          </div> 
        </div> 
      </div> 
    </div> 
  </div> 
  <div id="modalContainer" class="hidden"></div> 
  <script> 
    const API_BASE = window.location.origin; 
    let currentPage = 1; 
    const limit = 20; 
    let currentUserData = null; 

    // ================================================================= 
    // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ 
    // ================================================================= 
    /** ØªÙˆÚ¯Ù„ Ø¯Ø§Ø±Ú© Ù…ÙˆØ¯ **/ 
    const themeToggle = document.getElementById('themeToggle'); 
    themeToggle.addEventListener('click', () => { 
      document.body.classList.toggle('dark'); 
      const isDark = document.body.classList.contains('dark'); 
      localStorage.setItem('theme', isDark ? 'dark' : 'light'); 
      document.querySelector('#themeToggle i').className = isDark ? 'fas fa-sun' : 'fas fa-moon'; 
    }); 
    if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) { 
      document.body.classList.add('dark'); 
      document.querySelector('#themeToggle i').className = 'fas fa-sun'; 
    } else { 
      document.querySelector('#themeToggle i').className = 'fas fa-moon'; 
    } 
    /** Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… */ 
    function displayMessage(message, type = 'success') { 
      const container = document.querySelector('.container'); 
      const alert = document.createElement('div'); 
      let color = ''; 
      if (type === 'success') color = 'bg-green-100 border-green-400 text-green-700'; 
      else if (type === 'error') color = 'bg-red-100 border-red-400 text-red-700'; 
      else color = 'bg-blue-100 border-blue-400 text-blue-700'; 
      alert.className = 'p-4 border ' + color + ' rounded-lg mb-4 text-sm fixed top-0 left-1/2 transform -translate-x-1/2 mt-4 z-50 shadow-xl'; 
      alert.textContent = message; 
      container.prepend(alert); 
      setTimeout(() => alert.remove(), 5000); 
    } 
    /** ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Unix Timestamp */ 
    function formatTimestamp(timestamp) { 
      if (!timestamp || timestamp === 0) return '---'; 
      const date = new Date(timestamp * 1000); 
      return date.toLocaleDateString('fa-IR') + ' ' + date.toLocaleTimeString('fa-IR'); 
    } 
    /** ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® ISO String */ 
    function formatISO(isoString) { 
      if (!isoString) return '---'; 
      const date = new Date(isoString); 
      return date.toLocaleDateString('fa-IR') + ' ' + date.toLocaleTimeString('fa-IR'); 
    } 
    /** Ø§ÛŒØ¬Ø§Ø¯ Modal */ 
    function createModal(title, contentHTML) { 
      const modalContainer = document.getElementById('modalContainer'); 
      modalContainer.innerHTML = ''; 
      modalContainer.classList.remove('hidden'); 
      const isDark = document.body.classList.contains('dark'); 
      const modalOverlay = document.createElement('div'); 
      modalOverlay.className = 'modal-overlay'; 
      const modalContent = document.createElement('div'); 
      modalContent.className = 'modal-content w-full md:w-3/4 ' + (isDark ? 'modal-dark' : 'bg-white'); 
      modalContent.innerHTML = '<div class="flex justify-between items-center border-b pb-3 mb-4">' + 
        '<h3 class="text-xl font-bold ' + (isDark ? 'text-white' : 'text-gray-900') + '">' + title + '</h3>' + 
        '<button id="closeModal" class="text-gray-600 dark:text-gray-400 hover:text-red-500 transition">' + 
          '<i class="fas fa-times text-xl"></i>' + 
        '</button>' + 
        '</div>' + 
        '<div id="modalBody" class="max-h-96 overflow-y-auto">' + contentHTML + '</div>'; 
      modalContent.querySelector('#closeModal').addEventListener('click', () => { 
        modalContainer.classList.add('hidden'); 
        modalContainer.innerHTML = ''; 
      }); 
      modalOverlay.appendChild(modalContent); 
      modalContainer.appendChild(modalOverlay); 
    } 
    // ================================================================= 
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø± 
    // ================================================================= 
    async function loadStats() { 
      try { 
        const response = await fetch(API_BASE + '/stats'); 
        if (!response.ok) { 
          const errorData = await response.json().catch(() => ({ error: 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Worker' })); 
          displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø±: ' + (errorData.error || 'Ù†Ø§Ø´Ù†Ø§Ø³'), 'error'); 
          return; 
        } 
        const data = await response.json(); 
        if (data.success) { 
          const stats = data.stats; 
          document.getElementById('totalUsers').textContent = (stats.total_users || 0).toLocaleString('fa-IR'); 
          document.getElementById('totalActive').textContent = (stats.active_users || 0).toLocaleString('fa-IR'); 
          document.getElementById('newToday').textContent = (stats.new_today || 0).toLocaleString('fa-IR'); 
          document.getElementById('totalCoins').textContent = (stats.total_coins || 0).toLocaleString('fa-IR'); 
          document.getElementById('totalGems').textContent = (stats.total_gems || 0).toLocaleString('fa-IR'); 
          document.getElementById('bannedNow').textContent = (stats.banned_now || 0).toLocaleString('fa-IR'); 
        } else { 
          displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø±: ' + (data.error || 'Ù†Ø§Ø´Ù†Ø§Ø³'), 'error'); 
        } 
      } catch (error) { 
        displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø´Ø¨Ú©Ù‡: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø± Ù†Ø§Ù…ÙˆÙÙ‚', 'error'); 
        console.error('Error loading stats:', error); 
      } 
    } 
    // ================================================================= 
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ú¯Ù†Ø¬â€ŒÙ‡Ø§ 
    // ================================================================= 
    async function loadTreasureList() { 
      const body = document.getElementById('treasureListBody'); 
      body.innerHTML = '<tr><td colspan="5" class="p-4 text-center"><i class="fas fa-spinner fa-spin ml-2"></i> Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯Ù†Ø¬â€ŒÙ‡Ø§...</td></tr>'; 
      try { 
        const response = await fetch(API_BASE + '/list_treasures'); 
        if (!response.ok) { 
          body.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯Ù†Ø¬â€ŒÙ‡Ø§</td></tr>'; 
          return; 
        } 
        const data = await response.json(); 
        if (data.success) { 
          body.innerHTML = ''; 
          data.treasures.forEach(treasure => { 
            const row = document.createElement('tr'); 
            row.innerHTML = '<td class="px-6 py-4 whitespace-nowrap">' + treasure.id + '</td>' + 
              '<td class="px-6 py-4 whitespace-nowrap">' + treasure.name + '</td>' + 
              '<td class="px-6 py-4 whitespace-nowrap">' + 
                '<input type="number" value="' + treasure.coins_reward + '" class="treasure-coins-input w-24 p-1 border dark:border-gray-600 dark:bg-gray-700 rounded text-right" min="1" />' + 
              '</td>' + 
              '<td class="px-6 py-4 whitespace-nowrap">' + 
                '<input type="number" value="' + (treasure.timer_duration_seconds || 300) + '" class="treasure-duration-input w-24 p-1 border dark:border-gray-600 dark:bg-gray-700 rounded text-right" min="1" />' + 
              '</td>' + 
              '<td class="px-6 py-4 whitespace-nowrap">' + 
                '<button data-id="' + treasure.id + '" class="update-treasure-btn bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">' + 
                  '<i class="fas fa-save"></i> Ø°Ø®ÛŒØ±Ù‡' + 
                '</button>' + 
                '<button data-id="' + treasure.id + '" class="delete-treasure-btn bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 ml-2">' + 
                  '<i class="fas fa-trash"></i> Ø­Ø°Ù' + 
                '</button>' + 
              '</td>'; 
            body.appendChild(row); 
          }); 
          document.querySelectorAll('.update-treasure-btn').forEach(btn => { 
            btn.addEventListener('click', async (e) => { 
              const treasure_id = e.target.closest('button').getAttribute('data-id'); 
              const row = e.target.closest('tr'); 
              const coins_input = row.querySelector('.treasure-coins-input'); 
              const duration_input = row.querySelector('.treasure-duration-input'); 
              const coins = parseInt(coins_input.value); 
              const duration = parseInt(duration_input.value); 
              if (isNaN(coins) || coins < 1 || isNaN(duration) || duration < 1) { 
                displayMessage('Ù…Ù‚Ø¯Ø§Ø± Ø³Ú©Ù‡ Ùˆ Ø²Ù…Ø§Ù† (Ø«Ø§Ù†ÛŒÙ‡) Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error'); 
                return; 
              } 
              const result = await runAction('/update_treasure', 'POST', { treasure_id: treasure_id, coins_reward: coins, timer_duration_seconds: duration }); 
              if (result.success) { 
                displayMessage('Ù…Ù‚Ø¯Ø§Ø± Ø³Ú©Ù‡ Ùˆ Ø²Ù…Ø§Ù† Ú¯Ù†Ø¬ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.'); 
              } 
            }); 
          }); 
          document.querySelectorAll('.delete-treasure-btn').forEach(btn => { 
            btn.addEventListener('click', async (e) => { 
              const treasure_id = e.target.closest('button').getAttribute('data-id'); 
              if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú¯Ù†Ø¬ ' + treasure_id + ' Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) return; 
              const result = await runAction('/delete_treasure', 'POST', { treasure_id: treasure_id }); 
              if (result.success) { 
                displayMessage('Ú¯Ù†Ø¬ Ø­Ø°Ù Ø´Ø¯.'); 
                loadTreasureList(); 
              } 
            }); 
          }); 
        } else { 
          body.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">Ø®Ø·Ø§: ' + (data.error || 'Ù†Ø§Ù…Ø´Ø®Øµ') + '</td></tr>'; 
        } 
      } catch (error) { 
        body.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø´Ø¨Ú©Ù‡.</td></tr>'; 
        console.error('Error loading treasures:', error); 
      } 
    } 
    // ================================================================= 
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† 
    // ================================================================= 
    async function loadUserList(page = 1) { 
      currentPage = page; 
      const body = document.getElementById('userListBody'); 
      body.innerHTML = '<tr><td colspan="7" class="p-4 text-center"><i class="fas fa-spinner fa-spin ml-2"></i> Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...</td></tr>'; 
      try { 
        const response = await fetch(API_BASE + '/all_users?page=' + page + '&limit=' + limit); 
        if (!response.ok) { 
          const errorData = await response.json().catch(() => ({ error: 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Worker' })); 
          body.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-500">Ø®Ø·Ø§: ' + response.status + ' - ' + (errorData.error || 'Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±') + '</td></tr>'; 
          displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', 'error'); 
          return; 
        } 
        const data = await response.json(); 
        if (data.success) { 
          const users = data.users; 
          const total = data.total; 
          const totalPages = Math.ceil(total / limit); 
          document.getElementById('userCount').textContent = total.toLocaleString('fa-IR'); 
          document.getElementById('pageInfo').textContent = 'ØµÙØ­Ù‡ ' + page + ' Ø§Ø² ' + totalPages + ' (Ú©Ù„: ' + total + ')'; 
          document.getElementById('prevPageButton').disabled = (page <= 1); 
          document.getElementById('nextPageButton').disabled = (page >= totalPages || totalPages === 0); 
          body.innerHTML = ''; 
          if (users.length === 0) { 
            body.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500 dark:text-gray-400">Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>'; 
            return; 
          } 
          users.forEach(user => { 
            const activeStatus = user.active ? '<span class="text-green-500">ÙØ¹Ø§Ù„</span>' : '<span class="text-red-500">ØºÛŒØ±ÙØ¹Ø§Ù„</span>'; 
            const adminBadge = user.is_admin ? '<span class="text-xs mr-2 p-1 rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Ø§Ø¯Ù…ÛŒÙ†</span>' : ''; 
            const bannedBadge = user.ban_until > Math.floor(Date.now() / 1000) ? '<span class="text-xs mr-2 p-1 rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">Ø¨Ù†</span>' : ''; 
            const roleBadge = user.role ? '<span class="text-xs mr-2 p-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">' + user.role + '</span>' : ''; 
            const row = document.createElement('tr'); 
            row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700 transition cursor-pointer'; 
            row.innerHTML = '<td class="px-6 py-4 whitespace-nowrap">' + 
              '<span class="font-bold">' + user.name + '</span>' + 
              '<br>' + 
              '<span class="text-xs text-gray-500 dark:text-gray-400 font-mono">' + user.id + '</span>' + 
            '</td>' + 
            '<td class="px-6 py-4 whitespace-nowrap">' + 
              '<div>' + (user.coins || 0).toLocaleString('fa-IR') + ' Ø³Ú©Ù‡</div>' + 
              '<div>' + (user.gem || 0).toLocaleString('fa-IR') + ' Ø¬Ù…</div>' + 
            '</td>' + 
            '<td class="px-6 py-4 whitespace-nowrap">Ø³Ø·Ø­ ' + user.level + ' (' + user.job + ')</td>' + 
            '<td class="px-6 py-4 whitespace-nowrap text-sm">' + formatTimestamp(user.created_at) + '</td>' + 
            '<td class="px-6 py-4 whitespace-nowrap text-sm">' + formatTimestamp(user.last_login) + '</td>' + 
            '<td class="px-6 py-4 whitespace-nowrap text-sm">' + activeStatus + ' ' + adminBadge + ' ' + bannedBadge + ' ' + roleBadge + '</td>' + 
            '<td class="px-6 py-4 whitespace-nowrap text-sm">' + 
              '<button data-id="' + user.id + '" class="view-user-btn text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 font-medium">' + 
                '<i class="fas fa-eye"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡' + 
              '</button>' + 
            '</td>'; 
            body.appendChild(row); 
          }); 
          document.querySelectorAll('.view-user-btn').forEach(button => { 
            button.addEventListener('click', (e) => { 
              const id = e.currentTarget.getAttribute('data-id'); 
              fetchUserDetails(id); 
              // ØªØºÛŒÛŒØ± ØªØ¨ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† 
              document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-500')); 
              document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.add('text-gray-600', 'dark:text-gray-400')); 
              document.querySelector('[data-tab="tab-users"]').classList.add('active', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-500'); 
              document.querySelector('[data-tab="tab-users"]').classList.remove('text-gray-600', 'dark:text-gray-400'); 
              document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden')); 
              document.getElementById('tab-users').classList.remove('hidden'); 
            }); 
          }); 
        } else { 
          body.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-500">Ø®Ø·Ø§: ' + (data.error || 'Ù†Ø§Ù…Ø´Ø®Øµ') + '</td></tr>'; 
          displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', 'error'); 
        } 
      } catch (error) { 
        body.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø´Ø¨Ú©Ù‡.</td></tr>'; 
        displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø´Ø¨Ú©Ù‡: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù†Ø§Ù…ÙˆÙÙ‚', 'error'); 
        console.error('Error loading user list:', error); 
      } 
    } 
    document.getElementById('prevPageButton').addEventListener('click', () => { 
      if (currentPage > 1) loadUserList(currentPage - 1); 
    }); 
    document.getElementById('nextPageButton').addEventListener('click', () => { 
      loadUserList(currentPage + 1); 
    }); 
    // ================================================================= 
    // Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ú©Ø§Ø±Ø¨Ø± 
    // ================================================================= 
    document.getElementById('searchButton').addEventListener('click', async () => { 
      const query = document.getElementById('userSearchInput').value.trim(); 
      if (query.length < 2) { 
        displayMessage('Ø­Ø¯Ø§Ù‚Ù„ 2 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error'); 
        return; 
      } 
      try { 
        const response = await fetch(API_BASE + '/search_users?query=' + encodeURIComponent(query)); 
        if (!response.ok) { 
          displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ', 'error'); 
          return; 
        } 
        const data = await response.json(); 
        if (data.success) { 
          const users = data.users; 
          const resultsDiv = document.getElementById('searchResults'); 
          const resultsList = document.getElementById('searchResultsList'); 
          if (users.length === 0) { 
            resultsList.innerHTML = '<p class="text-center text-gray-500">Ù‡ÛŒÚ† Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>'; 
            resultsDiv.classList.remove('hidden'); 
            return; 
          } 
          resultsList.innerHTML = ''; 
          users.forEach(user => { 
            const userCard = document.createElement('div'); 
            userCard.className = 'p-3 border dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition flex justify-between items-center'; 
            const activeStatus = user.active ? '<span class="text-green-500">ÙØ¹Ø§Ù„</span>' : '<span class="text-red-500">ØºÛŒØ±ÙØ¹Ø§Ù„</span>'; 
            const adminBadge = user.is_admin ? '<span class="text-xs mr-2 p-1 rounded-full bg-yellow-100 text-yellow-800">Ø§Ø¯Ù…ÛŒÙ†</span>' : ''; 
            const bannedBadge = user.ban_until > Math.floor(Date.now() / 1000) ? '<span class="text-xs mr-2 p-1 rounded-full bg-red-100 text-red-800">Ø¨Ù†</span>' : ''; 
            userCard.innerHTML = '<div>' + 
              '<p class="font-bold">' + user.name + ' ' + adminBadge + ' ' + bannedBadge + '</p>' + 
              '<p class="text-sm text-gray-600 dark:text-gray-400">ID: ' + user.id + ' | Ø³Ú©Ù‡: ' + user.coins.toLocaleString('fa-IR') + ' | Ø¬Ù…: ' + (user.gem || 0).toLocaleString('fa-IR') + ' | Ø³Ø·Ø­: ' + user.level + '</p>' + 
              '</div>' + 
              '<button class="bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 text-sm">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button>'; 
            userCard.addEventListener('click', () => { 
              fetchUserDetails(user.id); 
              resultsDiv.classList.add('hidden'); 
            }); 
            resultsList.appendChild(userCard); 
          }); 
          resultsDiv.classList.remove('hidden'); 
        } else { 
          displayMessage('Ø®Ø·Ø§: ' + data.error, 'error'); 
        } 
      } catch (error) { 
        displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ', 'error'); 
        console.error('Search error:', error); 
      } 
    }); 
    // ================================================================= 
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ø±Ø¨Ø± (Ø¨Ø§ skip_login_update) 
    // ================================================================= 
    async function fetchUserDetails(id) { 
      const detailsDiv = document.getElementById('userDetails'); 
      detailsDiv.classList.remove('hidden'); 
      detailsDiv.scrollIntoView({ behavior: 'smooth' }); 
      try { 
        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² skip_login_update=1 Ø¨Ø±Ø§ÛŒ Ø¹Ø¯Ù… Ø¢Ù¾Ø¯ÛŒØª last_login 
        const response = await fetch(API_BASE + '/user?id=' + id + '&skip_login_update=1'); 
        if (!response.ok) { 
          const errorData = await response.json().catch(() => ({ error: 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Worker' })); 
          displayMessage('Ø¬Ø³ØªØ¬Ùˆ Ù†Ø§Ù…ÙˆÙÙ‚: ' + (errorData.error || 'Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯'), 'error'); 
          detailsDiv.classList.add('hidden'); 
          return; 
        } 
        const data = await response.json(); 
        if (data.success) { 
          const user = data.user; 
          currentUserData = user; 
          document.getElementById('userName').textContent = user.name; 
          document.getElementById('detailId').textContent = user.id; 
          document.getElementById('detailCreatedAt').textContent = formatTimestamp(user.created_at); 
          document.getElementById('detailLastLogin').textContent = formatTimestamp(user.last_login); 
          document.getElementById('detailReferral').textContent = user.referral_code; 
          const activeEl = document.getElementById('detailActive'); 
          activeEl.textContent = user.active ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'; 
          activeEl.className = user.active ? 'text-green-600 font-bold mr-1' : 'text-red-600 font-bold mr-1'; 
          const adminEl = document.getElementById('detailAdmin'); 
          adminEl.textContent = user.is_admin ? 'Ø§Ø¯Ù…ÛŒÙ†' : ''; 
          adminEl.classList.toggle('hidden', !user.is_admin); 
          const banEl = document.getElementById('detailBan'); 
          const now = Math.floor(Date.now() / 1000); 
          if (user.ban_until > now) { 
            const remainingMinutes = Math.ceil((user.ban_until - now) / 60); 
            banEl.textContent = 'ØªØ§ ' + user.ban_date + ' (Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒ: ' + remainingMinutes + ' Ø¯Ù‚ÛŒÙ‚Ù‡)'; 
            banEl.classList.add('text-red-500'); 
          } else { 
            banEl.textContent = 'Ø¨Ù† Ù†ÛŒØ³Øª'; 
            banEl.classList.remove('text-red-500'); 
          } 
          const roleEl = document.getElementById('detailRole'); 
          roleEl.textContent = user.role || 'user'; 
          document.getElementById('currentName').textContent = user.name; 
          document.getElementById('editName').value = user.name; 
          document.getElementById('currentCoins').textContent = (user.coins || 0).toLocaleString('fa-IR'); 
          document.getElementById('editCoins').value = user.coins; 
          document.getElementById('currentGem').textContent = (user.gem || 0).toLocaleString('fa-IR'); 
          document.getElementById('editGem').value = user.gem; 
          document.getElementById('currentJob').textContent = user.job; 
          document.getElementById('editJob').value = user.job; 
          document.getElementById('editRole').value = user.role || 'user'; 
          document.getElementById('currentLevel').textContent = (user.level || 1).toLocaleString('fa-IR'); 
          document.getElementById('editLevel').value = user.level; 
          document.getElementById('currentExp').textContent = (user.experience || 0).toLocaleString('fa-IR'); 
          document.getElementById('editExp').value = user.experience; 
          document.getElementById('toggleAdminButton').textContent = user.is_admin ? 'Ø­Ø°Ù ÙˆØ¶Ø¹ÛŒØª Ø§Ø¯Ù…ÛŒÙ†' : 'Ø§Ø¹Ø·Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø¯Ù…ÛŒÙ†'; 
          document.getElementById('toggleAdminButton').setAttribute('data-admin', user.is_admin ? '1' : '0'); 
          document.getElementById('toggleActiveButton').textContent = user.active ? 'ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù†' : 'ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù†'; 
          document.getElementById('toggleActiveButton').setAttribute('data-active', user.active ? '1' : '0'); 
        } else { 
          detailsDiv.classList.add('hidden'); 
          displayMessage('Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯: ' + id, 'error'); 
        } 
      } catch (error) { 
        detailsDiv.classList.add('hidden'); 
        displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ø¨Ø±', 'error'); 
        console.error('Error fetching user details:', error); 
      } 
    } 
    // ================================================================= 
    // ØªÙˆØ§Ø¨Ø¹ Modal 
    // ================================================================= 
    /** Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øª */ 
    document.getElementById('viewChatHistoryButton').addEventListener('click', () => { 
      if (!currentUserData) { 
        displayMessage('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯.', 'error'); 
        return; 
      } 
      let chatHTML = ''; 
      const messages = currentUserData.message_history || []; 
      if (messages.length === 0) { 
        chatHTML = '<p class="text-center text-gray-500 dark:text-gray-400">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾ÛŒØ§Ù…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>'; 
      } else { 
        chatHTML = '<ul class="space-y-3">'; 
        messages.slice().reverse().forEach(msg => { 
          chatHTML += '<li class="p-3 rounded-lg bg-gray-100 dark:bg-gray-700 shadow-sm">' + 
            '<p class="text-sm font-mono text-gray-600 dark:text-gray-300">' + formatISO(msg.timestamp) + '</p>' + 
            '<p class="mt-1">' + msg.message + '</p>' + 
            '</li>'; 
        }); 
        chatHTML += '</ul>'; 
      } 
      createModal('ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øª: ' + currentUserData.name, chatHTML); 
    }); 
    /** Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø§Ù…â€ŒÙ‡Ø§ */ 
    document.getElementById('viewNameHistoryButton').addEventListener('click', () => { 
      if (!currentUserData) { 
        displayMessage('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯.', 'error'); 
        return; 
      } 
      let historyHTML = ''; 
      const names = currentUserData.name_history || []; 
      if (names.length <= 1) { 
        historyHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù‡Ø±Ú¯Ø² Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ØªØºÛŒÛŒØ± Ù†Ø¯Ø§Ø¯Ù‡ Ø§Ø³Øª.</p>'; 
      } else { 
        historyHTML = '<ul class="space-y-3">'; 
        names.slice().reverse().forEach(item => { 
          historyHTML += '<li class="p-3 rounded-lg bg-gray-100 dark:bg-gray-700 shadow-sm flex justify-between items-center">' + 
            '<span class="font-bold">' + item.name + '</span>' + 
            '<span class="text-sm font-mono text-gray-600 dark:text-gray-300">' + formatISO(item.timestamp) + '</span>' + 
            '</li>'; 
        }); 
        historyHTML += '</ul>'; 
      } 
      createModal('ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø§Ù…â€ŒÙ‡Ø§: ' + currentUserData.name, historyHTML); 
    }); 
    // ================================================================= 
    // ØªÙˆØ§Ø¨Ø¹ Modal Ø¢Ù…Ø§Ø± (Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§) 
    // ================================================================= 
    // Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ù¾ÙˆÙ„Ø¯Ø§Ø±ØªØ±ÛŒÙ†â€ŒÙ‡Ø§ 
    document.getElementById('cardTotalCoins').addEventListener('click', async () => { 
      try { 
        const response = await fetch(API_BASE + '/top_coins?limit=10'); 
        const data = await response.json(); 
        if (data.success) { 
          let listHTML = '<ul class="space-y-2">'; 
          data.top_users.forEach((user, index) => { 
            listHTML += '<li class="flex justify-between p-2 rounded-lg bg-indigo-50 dark:bg-gray-700">' + 
              '<span>' + (index + 1) + '. ' + user.name + ' (' + user.id + ')</span>' + 
              '<span class="font-bold text-indigo-700 dark:text-indigo-300">' + user.coins.toLocaleString('fa-IR') + ' Ø³Ú©Ù‡</span>' + 
              '</li>'; 
          }); 
          listHTML += '</ul>'; 
          createModal('ğŸ”Ÿ Ù¾ÙˆÙ„Ø¯Ø§Ø±ØªØ±ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ø³Ú©Ù‡)', listHTML); 
        } 
      } catch (error) { 
        displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±ØªØ±', 'error'); 
      } 
    }); 
    // Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø¬Ù… 
    document.getElementById('cardTotalGems').addEventListener('click', async () => { 
      try { 
        const response = await fetch(API_BASE + '/top_gem?limit=10'); 
        const data = await response.json(); 
        if (data.success) { 
          let listHTML = '<ul class="space-y-2">'; 
          data.top_users.forEach((user, index) => { 
            listHTML += '<li class="flex justify-between p-2 rounded-lg bg-emerald-50 dark:bg-gray-700">' + 
              '<span>' + (index + 1) + '. ' + user.name + ' (' + user.id + ')</span>' + 
              '<span class="font-bold text-emerald-700 dark:text-emerald-300">' + (user.gem || 0).toLocaleString('fa-IR') + ' Ø¬Ù…</span>' + 
              '</li>'; 
          }); 
          listHTML += '</ul>'; 
          createModal('ğŸ”Ÿ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø¬Ù…', listHTML); 
        } 
      } catch (error) { 
        displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±ØªØ± Ø¬Ù…', 'error'); 
      } 
    }); 
    // Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù† Ø´Ø¯Ù‡ ÙØ¹Ø§Ù„ 
    document.getElementById('cardBannedNow').addEventListener('click', async () => { 
      try { 
        const response = await fetch(API_BASE + '/banned_users'); 
        const data = await response.json(); 
        if (data.success) { 
          let listHTML = '<ul class="space-y-2">'; 
          data.banned_users.forEach(user => { 
            listHTML += '<li class="p-2 rounded-lg bg-red-50 dark:bg-red-900 border border-red-300">' + 
              '<span class="font-bold">' + user.name + ' (' + user.id + ')</span>' + 
              '<br>' + 
              '<span class="text-sm text-gray-600 dark:text-gray-300">Ø¨Ù† ØªØ§: ' + formatTimestamp(user.ban_until) + '</span>' + 
              '</li>'; 
          }); 
          if (data.banned_users.length === 0) { 
            listHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Ú©Ø§Ø±Ø¨Ø± Ø¨Ù† Ø´Ø¯Ù‡ ÙØ¹Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>'; 
          } else { 
            listHTML += '</ul>'; 
          } 
          createModal('ğŸ”¨ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù† Ø´Ø¯Ù‡ ÙØ¹Ø§Ù„', listHTML); 
        } 
      } catch (error) { 
        displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù† Ø´Ø¯Ù‡', 'error'); 
      } 
    }); 
    // Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯ Ø§Ù…Ø±ÙˆØ² 
    document.getElementById('cardNewToday').addEventListener('click', async () => { 
      try { 
        const response = await fetch(API_BASE + '/top_new?limit=20'); 
        const data = await response.json(); 
        if (data.success) { 
          let listHTML = '<ul class="space-y-2">'; 
          data.new_users.forEach(user => { 
            listHTML += '<li class="flex justify-between p-2 rounded-lg bg-yellow-50 dark:bg-yellow-900">' + 
              '<span class="font-bold">' + user.name + ' (' + user.id + ')</span>' + 
              '<span class="text-sm font-mono text-gray-600 dark:text-gray-300">' + formatTimestamp(user.created_at) + '</span>' + 
              '</li>'; 
          }); 
          if (data.new_users.length === 0) { 
            listHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>'; 
          } else { 
            listHTML += '</ul>'; 
          } 
          createModal('ğŸ†• Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', listHTML); 
        } 
      } catch (error) { 
        displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯', 'error'); 
      } 
    }); 
    // Ø¯Ú©Ù…Ù‡ Ù†Ù…Ø§ÛŒØ´ Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ± 
    document.getElementById('btnShowRecentChats').addEventListener('click', async () => { 
      try { 
        const response = await fetch(API_BASE + '/recent_chats?limit=50'); 
        const data = await response.json(); 
        if (data.success) { 
          let listHTML = '<ul class="space-y-3">'; 
          data.recent_chats.forEach(chat => { 
            listHTML += '<li class="p-3 rounded-lg bg-blue-50 dark:bg-blue-900 border border-blue-300">' + 
              '<p class="font-bold text-sm">' + chat.user_name + ' <span class="text-xs font-mono text-gray-500">(' + chat.user_id + ')</span></p>' + 
              '<p class="text-xs text-gray-600 dark:text-gray-400 mb-1">' + formatISO(chat.timestamp) + '</p>' + 
              '<p class="text-sm">' + chat.message + '</p>' + 
              '</li>'; 
          }); 
          if (data.recent_chats.length === 0) { 
            listHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>'; 
          } else { 
            listHTML += '</ul>'; 
          } 
          createModal('ğŸ’¬ Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ± (50 ØªØ§ÛŒ Ø¢Ø®Ø±)', listHTML); 
        } 
      } catch (error) { 
        displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú†Øªâ€ŒÙ‡Ø§', 'error'); 
      } 
    }); 
    // Ø¯Ú©Ù…Ù‡ Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù† Ø´Ø¯Ù‡ 
    document.getElementById('btnShowListBanned').addEventListener('click', async () => { 
      try { 
        const response = await fetch(API_BASE + '/banned_users'); 
        const data = await response.json(); 
        if (data.success) { 
          let listHTML = '<ul class="space-y-2">'; 
          data.banned_users.forEach(user => { 
            listHTML += '<li class="p-3 rounded-lg bg-red-50 dark:bg-red-900 border border-red-300">' + 
              '<p class="font-bold">' + user.name + ' <span class="text-xs font-mono">(' + user.id + ')</span></p>' + 
              '<p class="text-sm text-gray-600 dark:text-gray-300">Ø¨Ù† ØªØ§: ' + formatTimestamp(user.ban_until) + '</p>' + 
              '</li>'; 
          }); 
          if (data.banned_users.length === 0) { 
            listHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Ú©Ø§Ø±Ø¨Ø± Ø¨Ù† Ø´Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>'; 
          } else { 
            listHTML += '</ul>'; 
          } 
          createModal('ğŸ”’ Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù† Ø´Ø¯Ù‡', listHTML); 
        } 
      } catch (error) { 
        displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù† Ø´Ø¯Ù‡', 'error'); 
      } 
    }); 
    // Ø¯Ú©Ù…Ù‡ Ø¨Ù† Ø¯Ø³ØªÙ‡â€ŒØ¬Ù…Ø¹ÛŒ 
    document.getElementById('btnShowBulkBan').addEventListener('click', async () => { 
      try { 
        const response = await fetch(API_BASE + '/all_users?page=1&limit=100'); 
        if (!response.ok) { 
          displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', 'error'); 
          return; 
        } 
        const data = await response.json(); 
        if (!data.success) { 
          displayMessage('Ø®Ø·Ø§: ' + data.error, 'error'); 
          return; 
        } 
        let modalHTML = '<div class="mb-4">' + 
          '<label class="block font-bold mb-2">Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø¨Ù† (Ø¯Ù‚ÛŒÙ‚Ù‡):</label>' + 
          '<input id="bulkBanMinutes" type="number" placeholder="Ù…Ø«Ø§Ù„: 60" class="w-full p-2 border dark:border-gray-600 dark:bg-gray-700 rounded" />' + 
          '</div>'; 
        modalHTML += '<div class="mb-4 max-h-96 overflow-y-auto border dark:border-gray-700 rounded p-2">'; 
        modalHTML += '<p class="font-bold mb-2">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ø­Ø¯Ø§Ú©Ø«Ø± 20 Ù†ÙØ±):</p>'; 
        data.users.forEach(user => { 
          const activeStatus = user.active ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'; 
          const adminBadge = user.is_admin ? ' [Ø§Ø¯Ù…ÛŒÙ†]' : ''; 
          modalHTML += '<div class="flex items-center mb-2 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">' + 
            '<input type="checkbox" class="bulk-ban-checkbox ml-2" value="' + user.id + '" />' + 
            '<label class="flex-grow cursor-pointer">' + 
              '<span class="font-bold">' + user.name + adminBadge + '</span>' + 
              '<span class="text-xs text-gray-600 dark:text-gray-400"> (ID: ' + user.id + ', Ø³Ú©Ù‡: ' + user.coins + ', ' + activeStatus + ')</span>' + 
            '</label>' + 
            '</div>'; 
        }); 
        modalHTML += '</div>'; 
        modalHTML += '<button id="bulkBanExecute" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 w-full mt-2">' + 
          '<i class="fas fa-hammer ml-2"></i> Ø§Ø¹Ù…Ø§Ù„ Ø¨Ù† Ø¯Ø³ØªÙ‡â€ŒØ¬Ù…Ø¹ÛŒ' + 
          '</button>'; 
        createModal('ğŸš« Ø¨Ù† Ø¯Ø³ØªÙ‡â€ŒØ¬Ù…Ø¹ÛŒ (Ø­Ø¯Ø§Ú©Ø«Ø± 20 Ú©Ø§Ø±Ø¨Ø±)', modalHTML); 
        // Event listener Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ø§Ø¹Ù…Ø§Ù„ Ø¨Ù† 
        document.getElementById('bulkBanExecute').addEventListener('click', async () => { 
          const minutes = parseInt(document.getElementById('bulkBanMinutes').value); 
          if (!minutes || minutes <= 0) { 
            displayMessage('Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø¨Ù† Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error'); 
            return; 
          } 
          const checkboxes = document.querySelectorAll('.bulk-ban-checkbox:checked'); 
          if (checkboxes.length === 0) { 
            displayMessage('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error'); 
            return; 
          } 
          if (checkboxes.length > 20) { 
            displayMessage('Ø­Ø¯Ø§Ú©Ø«Ø± 20 Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error'); 
            return; 
          } 
          const user_ids = Array.from(checkboxes).map(cb => cb.value); 
          if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ' + user_ids.length + ' Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø±Ø§ÛŒ ' + minutes + ' Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ù† Ú©Ù†ÛŒØ¯ØŸ')) return; 
          const result = await runAction('/bulk_ban', 'POST', { user_ids: user_ids, duration_minutes: minutes }); 
          if (result.success) { 
            displayMessage(result.data.message); 
            document.getElementById('modalContainer').classList.add('hidden'); 
            loadStats(); 
            loadUserList(currentPage); 
          } 
        }); 
      } catch (error) { 
        displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', 'error'); 
        console.error(error); 
      } 
    }); 
    // ================================================================= 
    // ØªÙˆØ§Ø¨Ø¹ Ø§Ú©Ø´Ù† (Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ) 
    // ================================================================= 
    /** Ø§Ø¬Ø±Ø§ÛŒ fetch Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ */ 
    async function runAction(endpoint, method = 'GET', body = null) { 
      const options = { method: method, headers: { 'Content-Type': 'application/json' }, }; 
      if (body) options.body = JSON.stringify(body); 
      try { 
        const response = await fetch(API_BASE + endpoint, options); 
        if (!response.ok) { 
          const errorData = await response.json().catch(() => ({ error: 'Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ± Ù†Ø§Ù…Ø´Ø®Øµ (' + response.status + ')' })); 
          displayMessage('Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ø§Ù…ÙˆÙÙ‚: ' + errorData.error, 'error'); 
          return { success: false, error: errorData.error }; 
        } 
        const data = await response.json(); 
        if (data.success || data.id) { 
          return { success: true, data: data }; 
        } else { 
          displayMessage('Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ø§Ù…ÙˆÙÙ‚: ' + (data.error || 'Ø®Ø·Ø§ÛŒ API'), 'error'); 
          return { success: false, error: data.error }; 
        } 
      } catch (error) { 
        displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø§ØªØµØ§Ù„ Ø¨Ù‡ API', 'error'); 
        console.error('Action error:', error); 
        return { success: false, error: 'Network Error' }; 
      } 
    } 
    /** Ø¹Ù…Ù„ÛŒØ§Øª Ø¢Ù¾Ø¯ÛŒØª Ø§ØµÙ„ÛŒ (Ù†Ø§Ù…, Ø³Ú©Ù‡â€ŒÙ‡Ø§, Ø¬Ù…, Ø´ØºÙ„, Ù†Ù‚Ø´) */ 
    document.getElementById('updateInfoButton').addEventListener('click', async () => { 
      const id = document.getElementById('detailId').textContent; 
      const coins = document.getElementById('editCoins').value; 
      const gem = document.getElementById('editGem').value; 
      const job = document.getElementById('editJob').value; 
      const name = document.getElementById('editName').value; 
      const role = document.getElementById('editRole').value; 
      const body = { id: id, coins: parseInt(coins), gem: parseInt(gem), job: job, name: name, role: role }; 
      const result = await runAction('/update', 'POST', body); 
      if (result.success) { 
        displayMessage('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.'); 
        fetchUserDetails(id); 
        loadStats(); 
        loadUserList(currentPage); 
      } 
    }); 
    /** Ø¹Ù…Ù„ÛŒØ§Øª Ø¢Ù¾Ø¯ÛŒØª Ø³Ø·Ø­ Ùˆ ØªØ¬Ø±Ø¨Ù‡ */ 
    document.getElementById('updateLevelExpButton').addEventListener('click', async () => { 
      const id = document.getElementById('detailId').textContent; 
      const level = document.getElementById('editLevel').value; 
      const experience = document.getElementById('editExp').value; 
      const body = { id: id, level: parseInt(level), experience: parseInt(experience) }; 
      const result = await runAction('/update', 'POST', body); 
      if (result.success) { 
        displayMessage('Ø³Ø·Ø­ Ùˆ ØªØ¬Ø±Ø¨Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.'); 
        fetchUserDetails(id); 
      } 
    }); 
    /** Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ù† */ 
    document.getElementById('banButton').addEventListener('click', async () => { 
      const id = document.getElementById('detailId').textContent; 
      const minutes = parseInt(document.getElementById('banMinutes').value); 
      if (!minutes || minutes <= 0) { 
        displayMessage('Ù„Ø·ÙØ§Ù‹ Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø¨Ù† Ù…Ø¹ØªØ¨Ø± (Ø¯Ù‚ÛŒÙ‚Ù‡) Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error'); 
        return; 
      } 
      if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú©Ø§Ø±Ø¨Ø± ' + id + ' Ø±Ø§ Ø¨Ø±Ø§ÛŒ ' + minutes + ' Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ù† Ú©Ù†ÛŒØ¯ØŸ')) return; 
      const result = await runAction('/ban', 'POST', { id: id, duration_minutes: minutes }); 
      if (result.success) { 
        displayMessage('Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ø§ÛŒ ' + minutes + ' Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ù† Ø´Ø¯.'); 
        fetchUserDetails(id); 
        loadStats(); 
        loadUserList(currentPage); 
      } 
    }); 
    /** Ø¹Ù…Ù„ÛŒØ§Øª Ø­Ø°Ù Ø¨Ù† */ 
    document.getElementById('unbanButton').addEventListener('click', async () => { 
      const id = document.getElementById('detailId').textContent; 
      if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ù† Ú©Ø§Ø±Ø¨Ø± ' + id + ' Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) return; 
      const result = await runAction('/ban', 'POST', { id: id, duration_minutes: 0 }); 
      if (result.success) { 
        displayMessage('Ø¨Ù† Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.'); 
        fetchUserDetails(id); 
        loadStats(); 
        loadUserList(currentPage); 
      } 
    }); 
    /** Ø¹Ù…Ù„ÛŒØ§Øª ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø§Ø¯Ù…ÛŒÙ† */ 
    document.getElementById('toggleAdminButton').addEventListener('click', async (e) => { 
      const id = document.getElementById('detailId').textContent; 
      const currentAdminStatus = e.currentTarget.getAttribute('data-admin') === '1'; 
      const newAdminStatus = !currentAdminStatus; 
      if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ÙˆØ¶Ø¹ÛŒØª Ø§Ø¯Ù…ÛŒÙ† Ø¨ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± ' + id + ' Ø±Ø§ Ø¨Ù‡ ' + (newAdminStatus ? 'Ø§Ø¯Ù…ÛŒÙ†' : 'Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ') + ' ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ØŸ')) return; 
      const result = await runAction('/update', 'POST', { id: id, is_admin: newAdminStatus }); 
      if (result.success) { 
        displayMessage('ÙˆØ¶Ø¹ÛŒØª Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ ' + (newAdminStatus ? 'Ø§Ø¯Ù…ÛŒÙ†' : 'Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ') + ' ØªØºÛŒÛŒØ± ÛŒØ§ÙØª.'); 
        fetchUserDetails(id); 
        loadStats(); 
      } 
    }); 
    /** Ø¹Ù…Ù„ÛŒØ§Øª ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± */ 
    document.getElementById('toggleActiveButton').addEventListener('click', async (e) => { 
      const id = document.getElementById('detailId').textContent; 
      const currentActiveStatus = e.currentTarget.getAttribute('data-active') === '1'; 
      const newActiveStatus = !currentActiveStatus; 
      if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± ' + id + ' Ø±Ø§ Ø¨Ù‡ ' + (newActiveStatus ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„') + ' ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ØŸ')) return; 
      const result = await runAction('/update', 'POST', { id: id, active: newActiveStatus }); 
      if (result.success) { 
        displayMessage('ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ ' + (newActiveStatus ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„') + ' ØªØºÛŒÛŒØ± ÛŒØ§ÙØª.'); 
        fetchUserDetails(id); 
        loadUserList(currentPage); 
        loadStats(); 
      } 
    }); 
    /** Ø¹Ù…Ù„ÛŒØ§Øª Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø± */ 
    document.getElementById('deleteButton').addEventListener('click', async () => { 
      const id = document.getElementById('detailId').textContent; 
      if (!confirm('Ù‡Ø´Ø¯Ø§Ø±: Ø¢ÛŒØ§ ÙˆØ§Ù‚Ø¹Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú©Ø§Ø±Ø¨Ø± ' + id + ' Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.')) return; 
      const result = await runAction('/delete', 'POST', { id: id }); 
      if (result.success) { 
        displayMessage('Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.'); 
        document.getElementById('userDetails').classList.add('hidden'); 
        loadUserList(1); 
        loadStats(); 
      } 
    }); 
    // Ø§ÙØ²ÙˆØ¯Ù† Ú¯Ù†Ø¬ Ø¬Ø¯ÛŒØ¯ 
    document.getElementById('addTreasureBtn').addEventListener('click', async () => { 
      const name = document.getElementById('newTreasureName').value.trim(); 
      const coins = parseInt(document.getElementById('newTreasureCoins').value); 
      const duration = parseInt(document.getElementById('newTreasureDuration').value); 
      if (!name || isNaN(coins) || coins < 1 || isNaN(duration) || duration < 1) { 
        displayMessage('Ù†Ø§Ù…, Ù…Ù‚Ø¯Ø§Ø± Ø³Ú©Ù‡ Ùˆ Ø²Ù…Ø§Ù† (Ø«Ø§Ù†ÛŒÙ‡) Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error'); 
        return; 
      } 
      const result = await runAction('/add_treasure', 'POST', { name: name, coins_reward: coins, timer_duration_seconds: duration }); 
      if (result.success) { 
        displayMessage('Ú¯Ù†Ø¬ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.'); 
        document.getElementById('newTreasureName').value = ''; 
        document.getElementById('newTreasureCoins').value = ''; 
        document.getElementById('newTreasureDuration').value = ''; 
        loadTreasureList(); 
      } 
    }); 
    // ØªØ¨Ø¯ÛŒÙ„ Ø³Ú©Ù‡ Ø¨Ù‡ Ø¬Ù… 
    document.getElementById('convertCoinsToGemButton').addEventListener('click', async () => { 
      const user_id = document.getElementById('convertUserId').value; 
      const amount = parseInt(document.getElementById('coinsToGemAmount').value); 
      if (!user_id || !amount || amount <= 0) { 
        displayMessage('Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù…Ù‚Ø¯Ø§Ø± Ø¬Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error'); 
        return; 
      } 
      const result = await runAction('/convert_currency', 'POST', { user_id, from: 'coins', to: 'gem', amount }); 
      if (result.success) { 
        displayMessage('ØªØ¨Ø¯ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ø³Ú©Ù‡: ' + result.data.new_coins + ', Ø¬Ù…: ' + result.data.new_gem); 
        // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ Ù‡Ù…Ø§Ù† Ú©Ø§Ø±Ø¨Ø± Ø§Ø³ØªØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù† 
        if (currentUserData && currentUserData.id === user_id) { 
          fetchUserDetails(user_id); 
        } 
        loadStats(); 
      } 
    }); 
    // ØªØ¨Ø¯ÛŒÙ„ Ø¬Ù… Ø¨Ù‡ Ø³Ú©Ù‡ 
    document.getElementById('convertGemToCoinsButton').addEventListener('click', async () => { 
      const user_id = document.getElementById('convertUserId2').value; 
      const amount = parseInt(document.getElementById('gemToCoinsAmount').value); 
      if (!user_id || !amount || amount <= 0) { 
        displayMessage('Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù…Ù‚Ø¯Ø§Ø± Ø¬Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error'); 
        return; 
      } 
      const result = await runAction('/convert_currency', 'POST', { user_id, from: 'gem', to: 'coins', amount }); 
      if (result.success) { 
        displayMessage('ØªØ¨Ø¯ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ø³Ú©Ù‡: ' + result.data.new_coins + ', Ø¬Ù…: ' + result.data.new_gem); 
        // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ Ù‡Ù…Ø§Ù† Ú©Ø§Ø±Ø¨Ø± Ø§Ø³ØªØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù† 
        if (currentUserData && currentUserData.id === user_id) { 
          fetchUserDetails(user_id); 
        } 
        loadStats(); 
      } 
    }); 
    // Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´ØºÙ„ 
    document.getElementById('jobSearchButton').addEventListener('click', async () => { 
      const job = document.getElementById('jobSearchInput').value.trim(); 
      if (!job) { 
        displayMessage('Ù„Ø·ÙØ§Ù‹ Ø´ØºÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error'); 
        return; 
      } 
      try { 
        const response = await fetch(API_BASE + '/search_by_job?job=' + encodeURIComponent(job)); 
        if (!response.ok) { 
          displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ', 'error'); 
          return; 
        } 
        const data = await response.json(); 
        if (data.success) { 
          const users = data.users; 
          const resultsDiv = document.getElementById('jobSearchResults'); 
          const resultsList = document.getElementById('jobSearchResultsList'); 
          if (users.length === 0) { 
            resultsList.innerHTML = '<p class="text-center text-gray-500">Ù‡ÛŒÚ† Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>'; 
            resultsDiv.classList.remove('hidden'); 
            return; 
          } 
          resultsList.innerHTML = ''; 
          users.forEach(user => { 
            const userCard = document.createElement('div'); 
            userCard.className = 'p-3 border dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition flex justify-between items-center'; 
            const activeStatus = user.active ? '<span class="text-green-500">ÙØ¹Ø§Ù„</span>' : '<span class="text-red-500">ØºÛŒØ±ÙØ¹Ø§Ù„</span>'; 
            const adminBadge = user.is_admin ? '<span class="text-xs mr-2 p-1 rounded-full bg-yellow-100 text-yellow-800">Ø§Ø¯Ù…ÛŒÙ†</span>' : ''; 
            const bannedBadge = user.ban_until > Math.floor(Date.now() / 1000) ? '<span class="text-xs mr-2 p-1 rounded-full bg-red-100 text-red-800">Ø¨Ù†</span>' : ''; 
            userCard.innerHTML = '<div>' + 
              '<p class="font-bold">' + user.name + ' ' + adminBadge + ' ' + bannedBadge + '</p>' + 
              '<p class="text-sm text-gray-600 dark:text-gray-400">ID: ' + user.id + ' | Ø³Ú©Ù‡: ' + user.coins.toLocaleString('fa-IR') + ' | Ø¬Ù…: ' + (user.gem || 0).toLocaleString('fa-IR') + ' | Ø³Ø·Ø­: ' + user.level + ' | Ø´ØºÙ„: ' + user.job + '</p>' + 
              '</div>' + 
              '<button class="bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 text-sm">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button>'; 
            userCard.addEventListener('click', () => { 
              fetchUserDetails(user.id); 
              resultsDiv.classList.add('hidden'); 
              // ØªØºÛŒÛŒØ± ØªØ¨ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† 
              document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-500')); 
              document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.add('text-gray-600', 'dark:text-gray-400')); 
              document.querySelector('[data-tab="tab-users"]').classList.add('active', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-500'); 
              document.querySelector('[data-tab="tab-users"]').classList.remove('text-gray-600', 'dark:text-gray-400'); 
              document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden')); 
              document.getElementById('tab-users').classList.remove('hidden'); 
            }); 
            resultsList.appendChild(userCard); 
          }); 
          resultsDiv.classList.remove('hidden'); 
        } else { 
          displayMessage('Ø®Ø·Ø§: ' + data.error, 'error'); 
        } 
      } catch (error) { 
        displayMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ', 'error'); 
        console.error('Job search error:', error); 
      } 
    }); 
    // ================================================================= 
    // Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯ 
    // ================================================================= 
    async function loadLeaderboard(type = 'coins') { 
      const container = document.getElementById('leaderboardContainer'); 
      container.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-8"><i class="fas fa-spinner fa-spin text-3xl mb-2"></i><p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯...</p></div>'; 
      
      try { 
        const endpoint = type === 'coins' ? '/top_coins?limit=50' : '/top_gem?limit=50'; 
        const response = await fetch(API_BASE + endpoint); 
        if (!response.ok) { 
          container.innerHTML = '<div class="text-center text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯</div>'; 
          return; 
        } 
        
        const data = await response.json(); 
        if (data.success) { 
          let html = '<div class="space-y-2">'; 
          data.top_users.forEach((user, index) => { 
            const rank = index + 1; 
            const rankClass = rank === 1 ? 'bg-yellow-100 dark:bg-yellow-900' :  
                            rank === 2 ? 'bg-gray-100 dark:bg-gray-800' :  
                            rank === 3 ? 'bg-orange-100 dark:bg-orange-900' :  
                            'bg-white dark:bg-gray-800'; 
            
            html += \`
              <div class="\${rankClass} p-4 rounded-lg border dark:border-gray-700 flex justify-between items-center"> 
                <div class="flex items-center"> 
                  <div class="text-2xl font-bold w-12 text-center">#\${rank}</div> 
                  <div class="mr-4"> 
                    <div class="font-bold text-lg">\${user.name}</div> 
                    <div class="text-sm text-gray-600 dark:text-gray-400">Ø³Ø·Ø­ \${user.level} | \${user.job || 'Ø¨ÛŒÚ©Ø§Ø±'}</div> 
                  </div> 
                </div> 
                <div class="text-left"> 
                  <div class="font-bold text-xl \${type === 'coins' ? 'text-amber-600' : 'text-emerald-600'}"> 
                    \${type === 'coins' ? user.coins.toLocaleString('fa-IR') + ' Ø³Ú©Ù‡' : (user.gem || 0).toLocaleString('fa-IR') + ' Ø¬Ù…'} 
                  </div> 
                  <div class="text-sm text-gray-500"> 
                    \${type === 'coins' ? (user.gem || 0).toLocaleString('fa-IR') + ' Ø¬Ù…' : user.coins.toLocaleString('fa-IR') + ' Ø³Ú©Ù‡'} 
                  </div> 
                </div> 
              </div> 
            \`; 
          }); 
          html += '</div>'; 
          container.innerHTML = html; 
        } else { 
          container.innerHTML = '<div class="text-center text-red-500">Ø®Ø·Ø§: ' + data.error + '</div>'; 
        } 
      } catch (error) { 
        container.innerHTML = '<div class="text-center text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±</div>'; 
      } 
    } 
    
    document.getElementById('showCoinsLeaderboard').addEventListener('click', () => loadLeaderboard('coins')); 
    document.getElementById('showGemsLeaderboard').addEventListener('click', () => loadLeaderboard('gem')); 
    
    // ================================================================= 
    // Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¨â€ŒÙ‡Ø§ 
    // ================================================================= 
    document.querySelectorAll('.tab-btn').forEach(button => { 
      button.addEventListener('click', () => { 
        const tabId = button.getAttribute('data-tab'); 
        // Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ 
        document.querySelectorAll('.tab-btn').forEach(btn => { 
          btn.classList.remove('active', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-500'); 
          btn.classList.add('text-gray-600', 'dark:text-gray-400'); 
        }); 
        button.classList.add('active', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-500'); 
        button.classList.remove('text-gray-600', 'dark:text-gray-400'); 
        // Ù†Ù…Ø§ÛŒØ´ ØªØ¨ Ù…Ø±ØªØ¨Ø· 
        document.querySelectorAll('.tab-content').forEach(tab => { 
          tab.classList.add('hidden'); 
        }); 
        document.getElementById(tabId).classList.remove('hidden'); 
        
        // Ø§Ú¯Ø± ØªØ¨ Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯ Ø§Ø³ØªØŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù† 
        if (tabId === 'tab-leaderboard') { 
          loadLeaderboard('coins'); 
        } 
      }); 
    }); 
    // ================================================================= 
    // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ 
    // ================================================================= 
    loadStats(); 
    loadUserList(1); 
    loadTreasureList(); 
  </script> 
</body> 
</html>`;

// =================================================================
// Export Ø§ØµÙ„ÛŒ Worker
// =================================================================
export default {
  async fetch(request, env, ctx) {
    try {
      const url = new URL(request.url);
      const db = env.DB;

      // ==================== Ø³Ø§Ø®Øª/ØªØ¹Ù…ÛŒØ± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ====================
      const tableCheck = await db.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='users'").all();
      if (tableCheck.results.length === 0) {
        await db.prepare(`
          CREATE TABLE users (
            id TEXT PRIMARY KEY,
            name TEXT NOT NULL,
            coins INTEGER DEFAULT 0,
            gem INTEGER DEFAULT 0,
            job TEXT DEFAULT 'Ø¨ÛŒÚ©Ø§Ø±',
            level INTEGER DEFAULT 1,
            experience INTEGER DEFAULT 0,
            message_history TEXT DEFAULT '[]',
            ban_until INTEGER DEFAULT 0,
            ban_date TEXT,
            name_history TEXT DEFAULT '[]',
            is_admin INTEGER DEFAULT 0,
            active INTEGER DEFAULT 1,
            referral_code TEXT,
            created_at INTEGER DEFAULT 0,
            last_login INTEGER DEFAULT 0,
            role TEXT DEFAULT 'user'
          )
        `).run();
      }

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³ØªÙˆÙ† gem Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
      const gemExists = await db.prepare(`SELECT COUNT(*) as cnt FROM pragma_table_info('users') WHERE name = 'gem'`).first();
      if (gemExists.cnt === 0) {
        await db.prepare(`ALTER TABLE users ADD COLUMN gem INTEGER DEFAULT 0`).run();
      }

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³ØªÙˆÙ† role Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
      const roleExists = await db.prepare(`SELECT COUNT(*) as cnt FROM pragma_table_info('users') WHERE name = 'role'`).first();
      if (roleExists.cnt === 0) {
        await db.prepare(`ALTER TABLE users ADD COLUMN role TEXT DEFAULT 'user'`).run();
      }

      // Ø³Ø§Ø®Øª Ø¬Ø¯ÙˆÙ„ ban_history
      const banHistoryCheck = await db.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='ban_history'").all();
      if (banHistoryCheck.results.length === 0) {
        await db.prepare(`
          CREATE TABLE ban_history (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            banned_by TEXT NOT NULL,
            duration_minutes INTEGER NOT NULL,
            ban_date TEXT,
            ban_until INTEGER NOT NULL,
            created_at INTEGER DEFAULT (strftime('%s', 'now'))
          )
        `).run();
      }

      // Ø¬Ø¯ÙˆÙ„ treasures
      const treasureCheck = await db.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='treasures'").all();
      if (treasureCheck.results.length === 0) {
        await db.prepare(`
          CREATE TABLE treasures (
            id INTEGER PRIMARY KEY,
            name TEXT NOT NULL,
            coins_reward INTEGER DEFAULT 100,
            timer_duration_seconds INTEGER DEFAULT 300
          )
        `).run();
      }

      // Ø¬Ø¯ÙˆÙ„ user_treasures
      const utCheck = await db.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='user_treasures'").all();
      if (utCheck.results.length === 0) {
        await db.prepare(`
          CREATE TABLE user_treasures (
            user_id TEXT NOT NULL,
            treasure_id INTEGER NOT NULL,
            last_claimed INTEGER DEFAULT 0,
            PRIMARY KEY (user_id, treasure_id)
          )
        `).run();
      }

      // ==================== Ù…Ø³ÛŒØ± Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª ====================
      if (url.pathname === '/xxi') {
        // Ú†Ú© Ú©Ø±Ø¯Ù† Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
        // Ø§Ú¯Ø± Ù„Ø§Ú¯ÛŒÙ† Ú©Ø±Ø¯Ù‡ØŒ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
        return new Response(ADMIN_HTML, {
          headers: { 
            'Content-Type': 'text/html; charset=utf-8',
            'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });
      }

      // ==================== Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯ Ø¹Ù…ÙˆÙ…ÛŒ ====================
      if (url.pathname === '/leaderboard' || url.pathname === '/lid') {
        const leaderboardHTML = `
      <!DOCTYPE html>
      <html lang="fa" dir="rtl">
      <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯ - ÛµÛ° Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±ØªØ±</title>
        <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
        <style>
          body { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); font-family: Tahoma, sans-serif; min-height: 100vh; padding: 2rem 1rem; }
          .container { max-width: 800px; margin: 0 auto; }
          .card { background: white; border-radius: 1.5rem; box-shadow: 0 20px 40px rgba(0,0,0,0.08); overflow: hidden; border: 1px solid #e0e7ff; }
          .header { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 2rem; text-align: center; }
          .header h1 { font-size: 2.5rem; font-weight: 900; margin: 0; }
          .header p { opacity: 0.9; margin-top: 0.5rem; font-size: 1.1rem; }
          .list-item { padding: 1.2rem 1.5rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
          .list-item:hover { background: #f8faff; transform: translateX(-4px); }
          .rank { font-size: 2rem; font-weight: 900; width: 80px; text-align: center; }
          .rank-1 { color: #f59e0b; }
          .rank-2 { color: #94a3b8; }
          .rank-3 { color: #f97316; }
          .user-info h3 { font-size: 1.4rem; font-weight: 700; margin: 0; color: #1e293b; }
          .user-info p { margin: 0.3rem 0 0; color: #64748b; font-size: 0.95rem; }
          .coins { font-size: 1.8rem; font-weight: 900; color: #f59e0b; }
          .gems { font-size: 1.8rem; font-weight: 900; color: #10b981; }
          .loading { text-align: center; padding: 4rem; color: #64748b; font-size: 1.5rem; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="card">
            <div class="header">
              <h1>Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯ Ø¨Ø§Ø²ÛŒ</h1>
              <p>ÛµÛ° Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ú©Ù‡ Ùˆ Ø¬Ù…</p>
              <div style="margin-top: 1rem;">
                <button id="showCoins" class="bg-amber-500 text-white px-4 py-2 rounded-l-lg">Ø³Ú©Ù‡</button>
                <button id="showGems" class="bg-emerald-500 text-white px-4 py-2 rounded-r-lg">Ø¬Ù…</button>
              </div>
            </div>
            <div id="leaderboard-list" class="loading">
              <i class="fas fa-spinner fa-spin text-5xl text-indigo-500"></i>
              <p class="mt-4">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
            </div>
          </div>
        </div>

        <script>
          const API_URL = location.origin;
          let currentMode = 'coins';

          async function loadLeaderboard(mode) {
            currentMode = mode;
            const container = document.getElementById('leaderboard-list');
            const endpoint = mode === 'coins' ? '/top_coins?limit=50' : '/top_gem?limit=50';
            try {
              const res = await fetch(API_URL + endpoint);
              if (!res.ok) throw new Error('Ø³Ø±ÙˆØ± Ù¾Ø§Ø³Ø® Ù†Ø¯Ø§Ø¯');
              const data = await res.json();

              if (!data.success || !Array.isArray(data.top_users) || data.top_users.length === 0) {
                container.innerHTML = '<div class="loading">Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
                return;
              }

              let html = '';
              data.top_users.forEach((user, i) => {
                const rank = i + 1;
                const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : '';
                const name = user.name || 'Ù†Ø§Ø´Ù†Ø§Ø³';
                const level = user.level || 1;
                const job = (user.job && user.job !== 'Ø¨ÛŒÚ©Ø§Ø±' && user.job !== null) ? user.job : 'Ø¨Ø¯ÙˆÙ† Ø´ØºÙ„';
                const coins = Number(user.coins || 0).toLocaleString('fa-IR');
                const gems = Number(user.gem || 0).toLocaleString('fa-IR');

                html += \`
                  <div class="list-item">
                    <div class="rank \${rankClass}">\${rank}</div>
                    <div class="user-info">
                      <h3>\${name}</h3>
                      <p>Ø³Ø·Ø­ \${level} â€¢ \${job}</p>
                    </div>
                    <div class="\${mode === 'coins' ? 'coins' : 'gems'}">\${mode === 'coins' ? coins + ' Ø³Ú©Ù‡' : gems + ' Ø¬Ù…'}</div>
                  </div>
                \`;
              });
              container.innerHTML = html;
            } catch (err) {
              container.innerHTML = '<div class="loading text-red-600">Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„!</div>';
            }
          }

          document.getElementById('showCoins').addEventListener('click', () => loadLeaderboard('coins'));
          document.getElementById('showGems').addEventListener('click', () => loadLeaderboard('gem'));

          loadLeaderboard('coins');
        </script>
      </body>
      </html>
